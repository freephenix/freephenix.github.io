<html>

<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
    æºç æ‚è´§é“ºï¼šsync.WaitGroup | åŠäº©æˆ¿é¡¶
</title>
<link rel="shortcut icon" href="https://freephenix.github.io//favicon.ico?v=1713840769430">
<!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous"> -->
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://freephenix.github.io//styles/main.css">
<!-- js -->
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://freephenix.github.io//media/js/jquery.sticky-sidebar.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>


    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-147240912-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-147240912-1');
    </script>
    
        
            
                <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
                <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
                

                    
                            
</head>

<body>
    <div class="main">
        <div class="header">
    <div class="nav">
        <div class="logo">
            <a href="https://freephenix.github.io/">
                <img class="avatar" src="https://freephenix.github.io//images/avatar.png?v=1713840769430" alt="">
            </a>
            <div class="site-title">
                <h1>
                    åŠäº©æˆ¿é¡¶
                </h1>
            </div>
        </div>
        <span class="menu-btn fa fa-align-justify"></span>
        <div class="menu-container">
            <ul>
                
                    
                            <li>
                                <a href="/" class="menu">
                                    é¦–é¡µ
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/archives" class="menu">
                                    å½’æ¡£
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/tags" class="menu">
                                    æ ‡ç­¾
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="https://freephenix.github.io//post/guan-yu-ban-mu-fang-ding/" class="menu">
                                    å…³äº
                                </a>
                            </li>
                            
                                
            </ul>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $(".menu-btn").click(function() {
            $(".menu-container").slideToggle();
        });
        $(window).resize(function() {

            if (window.matchMedia('(min-width: 960px)').matches) {
                $(".menu-container").css('display', 'block')
            } else {
                $(".menu-container").css('display', 'none')
            }

        });
    });
</script>

            <div id="main-content" class="post-detail main-container">
                <!-- left -->
                <div id="content" class="main-container-left">
                    <article class="post i-card">
                        <h2 class="post-title">
                            æºç æ‚è´§é“ºï¼šsync.WaitGroup
                        </h2>
                        <div class="post-info">
                            <time class="post-time">2021-01-11</time>
                            
                                <a href="https://freephenix.github.io/go/" class="post-tag i-tag
                            i-tag-error">
                            #Go
                        </a>
                                
                                <a href="https://freephenix.github.io/k_l-BPxc0/" class="post-tag i-tag
                            i-tag-error">
                            #æºç 
                        </a>
                                
                        </div>
                        
                            <div class="post-feature-image" style="background-image: url('https://freephenix.github.io//post-images/yuan-ma-za-huo-pu-syncwaitgroup.jpg')"></div>
                            
                                <div class="post-content">
                                    <p>äº†è§£ä¸€ä¸ªåŒ…çš„ä½¿ç”¨ï¼Œé¦–å…ˆä»é˜…è¯»å®ƒçš„æ³¨é‡Šå¼€å§‹</p>
<!-- more -->
<h1 id="ç®€ä»‹">ç®€ä»‹</h1>
<p>sync.WaitGroupç›¸ä¿¡å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œå½“æˆ‘ä»¬èµ·äº†å¤šä¸ªgoroutinueï¼Œä½†æ˜¯æœ‰å¸Œæœ›ä»–ä»¬åŒæ—¶readyä¹‹åå†åšä¸€äº›äº‹æƒ…çš„æ—¶å€™ï¼ŒWaitGroupå°±å¯ä»¥é—ªäº®ç™»åœºäº†ï¼Œä¸¾ä¸ªæ —å­ï¼š</p>
<pre><code>g := sync.WaitGroup{}
// è¾“å…¥å³å°†è¦ç­‰å¾…goroutinueçš„æ•°é‡
g.Add(2)
// func1
go func() {
	// do something
    // æ‰‹åŠ¨ç¡®è®¤å®Œæˆ
	g.Done()
}()

// func2
go func() {
	// do something
	g.Done()
}()
// æ­¤æ—¶çš„ä¸»goroutinueå°±ä¼šç­‰å¾… func1 func2å®Œæˆåå†ç»§ç»­å¾€ä¸‹è¿›è¡Œ
g.Wait()
</code></pre>
<p>å¯ä»¥è¯´æ˜¯ä½¿ç”¨ç›¸å½“æ–¹ä¾¿äº†ï¼Œå…¶æºç ä¹Ÿæ˜¯éå¸¸å°‘çš„<br>
sync.WaitGroupåŒ…æ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<pre><code>// A WaitGroup waits for a collection of goroutines to finish.
// The main goroutine calls Add to set the number of
// goroutines to wait for. Then each of the goroutines
// runs and calls Done when finished. At the same time,
// Wait can be used to block until all goroutines have finished.
//
// A WaitGroup must not be copied after first use.
</code></pre>
<p>åŒ…ä¸­å¤§ä½“çš„ç»“æ„ï¼š</p>
<pre><code>type WaitGroup struct {}
func (wg *WaitGroup) state() (statep *uint64, semap *uint32) {}
func (wg *WaitGroup) Add(delta int) {}
func (wg *WaitGroup) Done() {}
func (wg *WaitGroup) Wait() {}
</code></pre>
<p>ä¸‹é¢æ¥ä¸€ä¸ªä¸ªçœ‹å…¶ä¸­æœ‰ä»€ä¹ˆç„æœº</p>
<h1 id="waitgroup-struct">WaitGroup struct</h1>
<pre><code>// A WaitGroup waits for a collection of goroutines to finish.
// The main goroutine calls Add to set the number of
// goroutines to wait for. Then each of the goroutines
// runs and calls Done when finished. At the same time,
// Wait can be used to block until all goroutines have finished.
//
// A WaitGroup must not be copied after first use.
type WaitGroup struct {
	noCopy noCopy

	// 64-bit value: high 32 bits are counter, low 32 bits are waiter count.
	// 64-bit atomic operations require 64-bit alignment, but 32-bit
	// compilers do not ensure it. So we allocate 12 bytes and then use
	// the aligned 8 bytes in them as state, and the other 4 as storage
	// for the sema.
	state1 [3]uint32
}
</code></pre>
<h2 id="nocopy">noCopy</h2>
<p>æ³¨é‡Šä¸­å…¶å®ç®€å•å‘æˆ‘ä»¬ä»‹ç»äº†ç”¨æ³•ï¼Œè¿™é‡Œä¸å¤šè¯´äº†ã€‚æœ€åçš„ä¸€å¥è¯å¯ä»¥å…³æ³¨ä¸‹ï¼ŒWaitGroupä½¿ç”¨åï¼Œä¸å¯ä»¥å€¼æ‹·è´ï¼Œä¹Ÿå°±æ˜¯structä¸­çš„noCopyå£°æ˜å®ç°çš„æ•ˆæœï¼Œè¿™ä¸ªnoCopyçš„å®ç°å’ŒåŸç†å¤§å®¶å¯ä»¥å»æŸ¥é˜…ä¸‹èµ„æ–™ï¼Œgoæºç ä¸­æ³¨é‡Šå’Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre><code>// noCopy may be embedded into structs which must not be copied
// after the first use.
//
// See https://golang.org/issues/8005#issuecomment-190753527
// for details.
type noCopy struct{}
</code></pre>
<p>æœ‰æ—¶é—´äº†å¯ä»¥ç ”ç©¶ä¸‹ï¼Œè¿™é‡Œå…ˆç®€å•ä»‹ç»ä¸‹ï¼Œå®ƒæ˜¯LockåŒ…ä¸­çš„ä¸€ä¸ªç©ºç»“æ„ä½“ï¼Œå½“æˆ‘ä»¬ä¸å¸Œæœ›æŸä¸ªstructå¯ä»¥å€¼æ‹·è´æ—¶å€™å¯ä»¥åœ¨structå®šä¹‰é‡Œæ·»åŠ è¿™ä¸ªnoCopyç»“æ„ä½“ï¼Œéœ€è¦æ³¨æ„ï¼Œç¼–è¯‘æ—¶å€™noCopyä¸ä¼šå¯¼è‡´æŠ¥é”™ï¼Œå¯ä»¥ä½¿ç”¨go vetæ£€æŸ¥</p>
<h2 id="state1">state1</h2>
<p>è¿™ä¸ªæ˜¯waitGroup structä¸­å”¯ä¸€çš„ä¸€ä¸ªå˜é‡äº†ï¼Œé•¿åº¦ä¸º12ä¸ªå­—èŠ‚ï¼Œä¸‰ä¸ªå˜é‡å„ç”¨å››ä¸ªå­—èŠ‚ï¼Œä»æ³¨é‡Šä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°å…¶ä½œç”¨çš„åˆ’åˆ†ï¼Œ</p>
<ul>
<li>é«˜64ä½åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œé«˜32ä½å­˜addã€doneä¸¤ä¸ªå‡½æ•°æ“ä½œè®¡æ•°ï¼Œä½32ä½ç”¨äºWait çš„è®¡æ•°ï¼Œå­˜ç­‰å¾…ä¸­çš„goroutinueæ•°é‡</li>
<li>ä½32ä½ï¼Œå­˜å‚¨ä¿¡å·é‡ï¼Œç”¨äºç­‰å¾…å’Œå”¤é†’å„ä¸ªgoroutinueï¼Œruntime_Semrelease å’Œ runtime_Semacquireä¼šæ“ä½œ</li>
</ul>
<p>ä¸‹é¢å¼€å§‹ä¸€ä¸ªä¸ªå‡½æ•°é˜…è¯»</p>
<h1 id="stateå‡½æ•°">stateå‡½æ•°</h1>
<pre><code>// state returns pointers to the state and sema fields stored within wg.state1.
func (wg *WaitGroup) state() (statep *uint64, semap *uint32) {
	if uintptr(unsafe.Pointer(&amp;wg.state1))%8 == 0 {
		return (*uint64)(unsafe.Pointer(&amp;wg.state1)), &amp;wg.state1[2]
	} else {
		return (*uint64)(unsafe.Pointer(&amp;wg.state1[1])), &amp;wg.state1[0]
	}
}
</code></pre>
<p>è¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸¤ä¸ªè®¡æ•°å™¨å’Œä¿¡å·é‡ä¸¤ä¸ªæ•°æ®ï¼Œè¿™é‡Œçš„ifæ¡ä»¶å¾ˆæœ‰æ„æ€ï¼Œè¿™é‡Œå…¶å®æ˜¯åˆ¤æ–­äº†å˜é‡èµ·å§‹åœ°å€ï¼Œé™¤8èƒ½é™¤å°½ï¼Œè¡¨ç¤ºçš„æ˜¯state1èµ·å§‹åœ°å€æ˜¯å†…å­˜å¯¹é½çš„ï¼Œä¸¤ä¸ªè®¡æ•°å™¨æ•°æ®å­˜åœ¨ä¸€å®šå…³ç³»ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šå°†å‰8ä¸ªå­—èŠ‚æ”¾åœ¨ä¸€èµ·ï¼Œå­˜å‚¨ä¸¤ä¸ªè®¡æ•°å™¨ï¼Œè¿™æ ·å¯ä»¥è®©cpuä¸€æ¬¡è¯»å–ï¼Œæé«˜æ•ˆç‡</p>
<h1 id="addå‡½æ•°-å’Œ-doneå‡½æ•°">addå‡½æ•° å’Œ doneå‡½æ•°</h1>
<p>doneå‡½æ•°æœ¬è´¨å°±æ˜¯addå‡½æ•°ï¼Œä¸»è¦æ¥çœ‹ä¸‹addå‡½æ•°</p>
<pre><code>// Done decrements the WaitGroup counter by one.
func (wg *WaitGroup) Done() {
	wg.Add(-1)
}
</code></pre>
<p>ç›´æ¥ä¸Šaddå‡½æ•°æºç ï¼Œæ³¨é‡Šä¸­è§</p>
<pre><code>// Add adds delta, which may be negative, to the WaitGroup counter.
// addå‡½æ•°å¯èƒ½åŠ æ­£æ•°ä¹Ÿå¯èƒ½åŠ è´Ÿæ•°ï¼Œè´Ÿæ•°å³doneæ“ä½œ
// If the counter becomes zero, all goroutines blocked on Wait are released.
// å¦‚æœè®¡æ•°å™¨ä¸º0ï¼Œé‚£æ‰€æœ‰ç­‰å¾…çš„goroutinueå°±ä¼šè¢«é‡Šæ”¾
// If the counter goes negative, Add panics.
// å¦‚æœè®¡æ•°å™¨ä¸ºè´Ÿï¼Œè°ƒç”¨addä¼španicï¼Œå¯èƒ½æ˜¯ä½¿ç”¨æœ‰è¯¯æˆ–è€…å‡ºç°å¹¶å‘é—®é¢˜
// Note that calls with a positive delta that occur when the counter is zero
// must happen before a Wait. 
// addåªä¼šå‡ºç°åœ¨waitä¹‹å‰ï¼Œä»£ç ä¸­ä¸€ä¼šå„¿å¯ä»¥çœ‹åˆ°åˆ¤æ–­addå’Œwaitæœªå‡ºç°å¹¶å‘çš„æ ¡éªŒ
// Calls with a negative delta, or calls with a positive delta that start when
// the counter is greater than zero, may happen at any time.
// add å’Œ doneæ˜¯æœ‰å¯èƒ½å¹¶å‘çš„
// Typically this means the calls to Add should execute before the statement
// creating the goroutine or other event to be waited for.
// add æ“ä½œè¦æ”¾åœ¨èµ·goroutinueä¹‹å‰å’Œæœ‰äº‹æƒ…é˜»å¡ä¹‹å‰
// If a WaitGroup is reused to wait for several independent sets of events,
// new Add calls must happen after all previous Wait calls have returned.
// å¦‚æœè¦å¤ç”¨ä¸€ä¸ªwaitGroupï¼Œé‚£ä¹ˆaddæ“ä½œä¸€å®šè¦åœ¨ä¹‹å‰çš„waitç»“æŸä¹‹å
// See the WaitGroup example.
func (wg *WaitGroup) Add(delta int) {
    //å–è®¡æ•°å™¨å’Œä¿¡å·é‡ä¸¤ä¸ªå‚æ•°
	statep, semap := wg.state()
	if race.Enabled {
		// ç«æ€æ£€æŸ¥ç”¨ï¼Œå¯ä»¥æš‚ä¸å…³æ³¨
	}
    // AddUint64 ä¼šåŸå­çš„å°†ä¼ å‚åŠ åˆ°statepä¸Šï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªæ–°å€¼ï¼Œæ³¨æ„æ–°å€¼ï¼Œè¿™ä¸ªä¸‹é¢ä¼šç”¨åˆ°
    // åŸå­æ“ä½œè®¡æ•°å™¨çš„é«˜4ä½ï¼Œå³ add å’Œ doneæ“ä½œçš„å€¼
	state := atomic.AddUint64(statep, uint64(delta)&lt;&lt;32)
    //væ˜¯ add å’Œ doneæ“ä½œçš„å€¼
	v := int32(state &gt;&gt; 32)
    //wæ˜¯ ç”¨äºwaitçš„å€¼
	w := uint32(state)
	if race.Enabled &amp;&amp; delta &gt; 0 &amp;&amp; v == int32(delta) {
		// ç«æ€æ£€æŸ¥ç”¨ï¼Œå¯ä»¥æš‚ä¸å…³æ³¨
	}
    // vå°äºé›¶ï¼Œå³æ³¨é‡Šä¸­è¯´çš„add å’Œdoneçš„ä½¿ç”¨å‡ºç°äº†é—®é¢˜ï¼Œpanic
	if v &lt; 0 {
		panic(&quot;sync: negative WaitGroup counter&quot;)
	}
    // w != 0 è¯´æ˜æœ‰goroutinueèµ°åˆ°äº†waitï¼Œdelta &gt; 0 &amp;&amp; v == int32(delta) è¯´æ˜æ­£åœ¨è°ƒç”¨add
    // å³ï¼Œwaitä¸addå­˜åœ¨å¹¶å‘è°ƒç”¨ï¼Œæˆ–è€…é¡ºåºé¢ å€’ã€ä½¿ç”¨æœ‰è¯¯
	if w != 0 &amp;&amp; delta &gt; 0 &amp;&amp; v == int32(delta) {
		panic(&quot;sync: WaitGroup misuse: Add called concurrently with Wait&quot;)
	}
    // v &gt; 0 å³è°ƒç”¨äº†addï¼Œæˆ–è€…goroutinueä»¬è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œw == 0è¡¨ç¤ºè¿˜æ²¡æœ‰ç¨‹åºèµ°åˆ°wait
    // ç›´æ¥è¿”å›ç­‰å¾…åç»­æ“ä½œå³å¯
	if v &gt; 0 || w == 0 {
		return
	}
    // æ­¤æ—¶ï¼Œv == 0ï¼Œå³æ‰€æœ‰goroutinueéƒ½å·²ç»æ‰§è¡Œäº†doneï¼Œå¹¶ä¸”w!=0ï¼Œå³æœ‰goroutinueå¼€å§‹ç­‰å¾…
	// This goroutine has set counter to 0 when waiters &gt; 0.
	// Now there can't be concurrent mutations of state:
	// - Adds must not happen concurrently with Wait,
	// - Wait does not increment waiters if it sees counter == 0.
	// Still do a cheap sanity check to detect WaitGroup misuse.
    // åœ¨v==0çš„æƒ…å†µä¸‹ï¼Œè¯´æ˜goroutinueéƒ½å·²ç»æ‰§è¡Œdoneå®Œæ¯•äº†ï¼Œwaitå‡½æ•°å°±ä¸ä¼šæœ‰
    // é˜»å¡æ•ˆæœï¼ˆä¸€ä¼šå„¿waitä»£ç ä¸­èƒ½çœ‹åˆ°ï¼‰ï¼Œæ­¤æ—¶statepï¼ˆåŸå€¼åœ°å€ï¼‰
    // ä¸ç­‰äºstate(åŸå­æ“ä½œåçš„æ–°å€¼)ï¼Œåªä¼šæ˜¯åˆæœ‰addå‚ä¸äº†æ‰§è¡Œï¼Œè‡´ä½¿åŸå€¼å‘ç”Ÿæ”¹å˜
    // æœ¬æ¬¡æ“ä½œä¸ºdoneï¼Œæ­¤æ—¶æ¥ä¸‹æ¥è¦åšçš„waitè¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œ
    // åˆæœ‰æ–°çš„addï¼Œè¯´æ˜waitå’Œaddå¹¶å‘æ‰§è¡Œäº†
	if *statep != state {
		panic(&quot;sync: WaitGroup misuse: Add called concurrently with Wait&quot;)
	}
	// Reset waiters count to 0.
	*statep = 0
    // doneå‡å®Œæ¯•ï¼Œå¼€å§‹é‡Šæ”¾ä¿¡å·é‡
	for ; w != 0; w-- {
		runtime_Semrelease(semap, false, 0)
	}
}
</code></pre>
<h1 id="wait-å‡½æ•°">wait å‡½æ•°</h1>
<p>æ³¨é‡Šè§</p>
<pre><code>// Wait blocks until the WaitGroup counter is zero.
func (wg *WaitGroup) Wait() {
	statep, semap := wg.state()
	if race.Enabled {
		// ç«æ€æ£€æŸ¥ç”¨ï¼Œå¯ä»¥æš‚ä¸å…³æ³¨
	}
	for 
        // åŸå­åŠ è½½statep
		state := atomic.LoadUint64(statep)
		v := int32(state &gt;&gt; 32)
		w := uint32(state)
        // v==0è¡¨ç¤ºdoneæ‰§è¡Œå®Œæ¯•ï¼Œä¸éœ€è¦é˜»å¡äº†
		if v == 0 {
			// Counter is 0, no need to wait.
			if race.Enabled {
				// ç«æ€æ£€æŸ¥ç”¨ï¼Œå¯ä»¥æš‚ä¸å…³æ³¨
			}
			return
		}
		// Increment waiters count.
        // æ­¤æ—¶ä¼šå…ˆæ¯”è¾ƒstatepå’Œstateæ˜¯å¦ç›¸ç­‰ï¼Œå³æœ‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹åœ¨æ“ä½œï¼Œ
        // å¦‚æœä¾ç„¶ç›¸ç­‰åˆ™ç”¨state+1å¤åˆ¶ç»™statep
		if atomic.CompareAndSwapUint64(statep, state, state+1) {
			if race.Enabled &amp;&amp; w == 0 {
				// ç«æ€æ£€æŸ¥ç”¨ï¼Œå¯ä»¥æš‚ä¸å…³æ³¨
			}
            // åœ¨semapä¸Šç­‰å¾…ä¿¡å·é‡
			runtime_Semacquire(semap)
            // addå‡½æ•°ä¸­é‡Šæ”¾ä¿¡å·é‡æ—¶ï¼Œstatepå·²ç»è¢«æ¸…é›¶äº†ï¼Œå¦‚æœæ­¤æ—¶ä¸ä¸ºé›¶è¯´æ˜åˆæœ‰addæ‰§è¡Œäº†
			if *statep != 0 {
				panic(&quot;sync: WaitGroup is reused before previous Wait has returned&quot;)
			}
			if race.Enabled {
				// ç«æ€æ£€æŸ¥ç”¨ï¼Œå¯ä»¥æš‚ä¸å…³æ³¨
			}
			return
		}
	}
}
</code></pre>
<h1 id="ä¿¡å·é‡æ“ä½œ">ä¿¡å·é‡æ“ä½œ</h1>
<p>ä¿¡å·é‡ç›¸æ¯”å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œè¿™é‡Œè´´ä¸‹ä¸¤ä¸ªå‡½æ•°çš„æ³¨é‡Šï¼Œæ„Ÿå…´è¶£å¯ä»¥æ·±å…¥ç ”ç©¶ä¸‹ï¼Œè¿™é‡Œæš‚ä¸è®¨è®ºäº†<br>
runtime_Semrelease</p>
<pre><code>// Semrelease atomically increments *s and notifies a waiting goroutine
// if one is blocked in Semacquire.
// It is intended as a simple wakeup primitive for use by the synchronization
// library and should not be used directly.
// If handoff is true, pass count directly to the first waiter.
// skipframes is the number of frames to omit during tracing, counting from
// runtime_Semrelease's caller.
func runtime_Semrelease(s *uint32, handoff bool, skipframes int)
</code></pre>
<p>runtime_Semacquire</p>
<pre><code>// Semacquire waits until *s &gt; 0 and then atomically decrements it.
// It is intended as a simple sleep primitive for use by the synchronization
// library and should not be used directly.
func runtime_Semacquire(s *uint32)
</code></pre>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>åˆ°è¿™é‡Œæ‰€æœ‰çš„ä»£ç éƒ½å·²ç»è¯»è¿‡äº†ï¼ŒwaitGroupçš„ä»£ç é‡ç¡®å®å¹¶ä¸å¤šï¼Œä½†æ˜¯æœ‰æ¯”è¾ƒå®ç”¨ï¼Œå»ºè®®å¤šçœ‹çœ‹ï¼Œç¢ç£¨ç¢ç£¨ï¼Œæœ‰å¾ˆå¤šç»†èŠ‚å€¼å¾—æˆ‘ä»¬å»å­¦ä¹ ï¼Œæ¯”å¦‚åŸå­åšåŠ æ³•ã€æ—¶åˆ»è­¦æƒ•æ ¡éªŒå¼‚å¸¸å¹¶å‘ç­‰ç­‰<br>
å¹¶å‘é—®é¢˜ï¼Œç¡®å®æ˜¯ä¸€ä¸ªå¿ƒæ™ºä¸Šç›¸å¯¹æ›´éš¾ç†è§£ï¼Œä½†æ˜¯æˆ‘ä»¬å´æ›´åŠ éœ€è¦ç‰¹åˆ«æ³¨æ„çš„é—®é¢˜ï¼Œå°¤å…¶æ˜¯æˆ‘è¿™ç§ä»PHPä¸€æŠŠæ¢­è½¬åˆ°goè¯­è¨€çš„èœé¸Ÿï¼Œè¸©äº†ä¸å°‘å‘ã€‚è¿˜æœ›å¤§ä½¬ä»¬å¤šå¤šæŒ‡ç‚¹ğŸ™</p>
<p>ä¸‹é¢æ˜¯æ€»ç»“ä¸‹waitGroupæµç¨‹çš„ä¸€ä¸ªç®€æ˜“å›¾è§£ï¼š<br>
<img src="https://freephenix.github.io//post-images/1610490130883.png" alt="waitGroup" loading="lazy"></p>
<h1 id="å¼•ç”¨æ–‡ç« ">å¼•ç”¨æ–‡ç« </h1>
<ul>
<li><a href="http://yangxikun.com/golang/2020/02/15/golang-sync-waitgroup.html">sync.waitgroup æºç è§£æ</a></li>
<li><a href="https://www.cnblogs.com/rongfengliang/p/14092207.html">golang noCopy çš„åŠŸèƒ½</a></li>
<li><a href="https://github.com/golang/go/issues/8005#issuecomment-190753527">github noCopyç‰¹æ€§è®¨è®º</a></li>
<li><a href="https://golang.org/cmd/vet/">go vet</a></li>
<li><a href="https://blog.csdn.net/yanluandai1985/article/details/82686486">æ— é”æœºåˆ¶----æ¯”è¾ƒäº¤æ¢CAS Compare And Swap</a></li>
<li><a href="https://blog.csdn.net/qq_19782019/article/details/79746627">æ“ä½œç³»ç»Ÿä¹‹ä¿¡å·é‡</a></li>
</ul>

                                </div>
                    </article>
                    <!--  -->
                    
                        <div class="next-post">
                            <div class="next">ä¸‹ä¸€ç¯‡</div>
                            <a href="https://freephenix.github.io/k8s-xue-xi-bi-ji-yi-jia-gou-jie-shao/">
                                <h3 class="post-title">
                                    K8så­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰æ¶æ„ä»‹ç»
                                </h3>
                            </a>
                        </div>
                        
                            <div id="disqus_thread"></div>
                            <div id="gitalk-container"></div>
                </div>
                <!-- middle -->
                <div class="main-container-middle"></div>
                <!-- right -->
                <div id="sidebar" class="main-container-right">
                    
                        <!-- toc -->
                        
    <div class="toc-card i-card ">
        <div class="toc-title i-card-title">ç›®å½•</div>
        <div class="toc-content">
            <ul class="markdownIt-TOC">
<li><a href="#%E7%AE%80%E4%BB%8B">ç®€ä»‹</a></li>
<li><a href="#waitgroup-struct">WaitGroup struct</a>
<ul>
<li><a href="#nocopy">noCopy</a></li>
<li><a href="#state1">state1</a></li>
</ul>
</li>
<li><a href="#state%E5%87%BD%E6%95%B0">stateå‡½æ•°</a></li>
<li><a href="#add%E5%87%BD%E6%95%B0-%E5%92%8C-done%E5%87%BD%E6%95%B0">addå‡½æ•° å’Œ doneå‡½æ•°</a></li>
<li><a href="#wait-%E5%87%BD%E6%95%B0">wait å‡½æ•°</a></li>
<li><a href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%93%8D%E4%BD%9C">ä¿¡å·é‡æ“ä½œ</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
<li><a href="#%E5%BC%95%E7%94%A8%E6%96%87%E7%AB%A0">å¼•ç”¨æ–‡ç« </a></li>
</ul>

        </div>
        <script>
            function locateCatelogList() {
                /*è·å–æ–‡ç« ç›®å½•é›†åˆ,å¯é€šè¿‡:headerè¿‡æ»¤å™¨*/
                var alis = $('.post-content :header');
                /*è·å–ä¾§è¾¹æ ç›®å½•åˆ—è¡¨é›†åˆ**/
                var sidebar_alis = $('.markdownIt-TOC a');
                /*è·å–æ»šåŠ¨æ¡åˆ°é¡¶éƒ¨çš„è·ç¦»*/
                var scroll_height = $(window).scrollTop();
                for (var i = 0; i < alis.length; i++) {
                    /*è·å–é”šç‚¹é›†åˆä¸­çš„å…ƒç´ åˆ†åˆ«åˆ°é¡¶ç‚¹çš„è·ç¦»*/
                    var a_height = $(alis[i]).offset().top;
                    if (a_height < scroll_height) {
                        /*é«˜äº®æ˜¾ç¤º*/
                        sidebar_alis.removeClass('on');
                        $(sidebar_alis[i]).addClass('on');
                    }
                }
            }
            $(function() {
                /*ç»‘å®šæ»šåŠ¨äº‹ä»¶ */
                $(window).bind('scroll', locateCatelogList);
            });
        </script>
    </div>
    
                            

                </div>




            </div>


            <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | 
  <a class="rss" href="https://freephenix.github.io//atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>


    </div>
    <script>
        $('#sidebar').stickySidebar({
            topSpacing: 80,
            // bottomSpacing: 60
        });
    </script>
    
        
            <script>
    window.onload = function() {
        var gitalk = new Gitalk({
            clientID: '008503f8c8bca8787fbe',
            clientSecret: '5f789f71e3288ff1866d17523348881053068eb4',
            repo: 'freephenix.github.io',
            owner: 'freephenix',
            admin: ['freephenix'],
            id: (location.pathname).substring(0, 49), // Ensure uniqueness and length less than 50
            distractionFreeMode: false // Facebook-like distraction free mode
        })

        gitalk.render('gitalk-container')
    }
</script>
                

                    
                                
</body>

</html>