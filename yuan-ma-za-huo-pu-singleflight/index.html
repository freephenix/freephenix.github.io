<html>

<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
    æºç æ‚è´§é“ºï¼šsingleflight | åŠäº©æˆ¿é¡¶
</title>
<link rel="shortcut icon" href="https://freephenix.github.io//favicon.ico?v=1713840769430">
<!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous"> -->
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://freephenix.github.io//styles/main.css">
<!-- js -->
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://freephenix.github.io//media/js/jquery.sticky-sidebar.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>


    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-147240912-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-147240912-1');
    </script>
    
        
            
                <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
                <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
                

                    
                            
</head>

<body>
    <div class="main">
        <div class="header">
    <div class="nav">
        <div class="logo">
            <a href="https://freephenix.github.io/">
                <img class="avatar" src="https://freephenix.github.io//images/avatar.png?v=1713840769430" alt="">
            </a>
            <div class="site-title">
                <h1>
                    åŠäº©æˆ¿é¡¶
                </h1>
            </div>
        </div>
        <span class="menu-btn fa fa-align-justify"></span>
        <div class="menu-container">
            <ul>
                
                    
                            <li>
                                <a href="/" class="menu">
                                    é¦–é¡µ
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/archives" class="menu">
                                    å½’æ¡£
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/tags" class="menu">
                                    æ ‡ç­¾
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="https://freephenix.github.io//post/guan-yu-ban-mu-fang-ding/" class="menu">
                                    å…³äº
                                </a>
                            </li>
                            
                                
            </ul>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $(".menu-btn").click(function() {
            $(".menu-container").slideToggle();
        });
        $(window).resize(function() {

            if (window.matchMedia('(min-width: 960px)').matches) {
                $(".menu-container").css('display', 'block')
            } else {
                $(".menu-container").css('display', 'none')
            }

        });
    });
</script>

            <div id="main-content" class="post-detail main-container">
                <!-- left -->
                <div id="content" class="main-container-left">
                    <article class="post i-card">
                        <h2 class="post-title">
                            æºç æ‚è´§é“ºï¼šsingleflight
                        </h2>
                        <div class="post-info">
                            <time class="post-time">2021-01-21</time>
                            
                                <a href="https://freephenix.github.io/go/" class="post-tag i-tag
                            i-tag-other_1">
                            #Go
                        </a>
                                
                                <a href="https://freephenix.github.io/k_l-BPxc0/" class="post-tag i-tag
                            i-tag-info">
                            #æºç 
                        </a>
                                
                                <a href="https://freephenix.github.io/mKJdR76q2/" class="post-tag i-tag
                            i-tag-error">
                            #å¹¶å‘
                        </a>
                                
                        </div>
                        
                            <div class="post-feature-image" style="background-image: url('https://freephenix.github.io//post-images/yuan-ma-za-huo-pu-singleflight.jpg')"></div>
                            
                                <div class="post-content">
                                    <p>å½“ç¼“å­˜è¢«å‡»ç©¿ï¼ŒDBä¸è¢«å‹å®çš„ä¸€ä¸ªè§£æ³•</p>
<!-- more -->
<h1 id="ç®€ä»‹">ç®€ä»‹</h1>
<p>è¿™ä¸€åˆ‡éƒ½æºäºä¸€ä¸ªå¤§æ¥å£çš„ä¼˜åŒ–ï¼Œå½“å¹¶å‘å‡é«˜ï¼Œå¾ˆå¤šç¼“å­˜æœ‰å¯èƒ½åŒæ—¶å¤±æ•ˆæ—¶ï¼Œå¦‚ä½•é˜²æ­¢DBè¢«æ‰“æŒ‚ï¼Œå°½å¯èƒ½çš„ä¿æŠ¤ï¼Ÿé‡å¤çš„è¯·æ±‚ï¼Œé‡å¤çš„èµ„æºï¼Œå¦‚æœèŠ‚çº¦æˆæœ¬ï¼Ÿ<br>
è¿™ä¸€åˆ‡ï¼Œæœ‰ä¸€ä¸ªè§£æ³• -- singleflight</p>
<h1 id="ç»“æ„ä½“">ç»“æ„ä½“</h1>
<pre><code>// call is an in-flight or completed singleflight.Do call
// call è¡¨ç¤ºä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„æˆ–å·²å®Œæˆçš„å‡½æ•°è°ƒç”¨ï¼Œå­˜å‚¨è°ƒç”¨çš„æ¥å£ã€æŠ¥é”™ä¸€äº›æ ‡è®°ç­‰ç­‰ï¼Œ
type call struct {
    // å¯ä»¥çœ‹åˆ°ï¼Œsingleflightå®ç°ä¸­ç”¨åˆ°äº†WaitGroup
	wg sync.WaitGroup

	// These fields are written once before the WaitGroup is done
	// and are only read after the WaitGroup is done.
    // è®°å½•ç»“æœï¼Œåœ¨WaitGroupå®Œæˆä¹‹å‰ï¼Œåªä¼šå†™å…¥ä¸€æ¬¡ï¼Œé‡ç‚¹åœ¨æ­¤äº†
	val interface{}
	err error

	// forgotten indicates whether Forget was called with this call's key
	// while the call was still in flight.
    // ç”¨æ¥æ ‡è¯†æ‰§è¡Œå®Œæˆä¹‹åç»“æœç«‹é©¬åˆ é™¤è¿˜æ˜¯ä¿ç•™åœ¨singleflightä¸­
	forgotten bool

	// These fields are read and written with the singleflight
	// mutex held before the WaitGroup is done, and are read but
	// not written after the WaitGroup is done.
    // è¿™ä¸ªå­—æ®µè®°å½•æ‰§è¡Œæ¬¡æ•°ï¼Œæ›´æ–°æ—¶æœºæ˜¯å‘èµ·è¯·æ±‚ï¼ŒwaitGroupæ‰§è¡Œå®Œæˆâ€˜ä¹‹å‰â€™
	dups  int
    // ç”¨æ¥è®°å½•DoChanä¸­éœ€è¦è¿”å›çš„æ•°æ®
	chans []chan&lt;- Result
}

// Group represents a class of work and forms a namespace in
// which units of work can be executed with duplicate suppression.
// ç”¨æ¥è®°å½•å·²ç»å­˜åœ¨çš„å¯¹æŸkeyçš„è¯·æ±‚å’Œå¯¹åº”çš„å®é™…è¯·æ±‚å‡½æ•°ï¼ˆcallï¼‰çš„æ˜ å°„
type Group struct {
	mu sync.Mutex       // protects m åŠ é”ä¿æŠ¤m
	m  map[string]*call // lazily initialized  æ‡’åŠ è½½
}

// Result holds the results of Do, so they can be passed
// on a channel.
// è®°å½•ç»“æœï¼Œç»“æœå€¼Valï¼Œç»“æœæŠ¥é”™Errï¼Œç»“æœæ˜¯å®é™…è¯·æ±‚è¿˜æ˜¯åˆ†äº«çš„è¿”å›
type Result struct {
	Val    interface{}
	Err    error
	Shared bool
}
</code></pre>
<h1 id="æ–¹æ³•">æ–¹æ³•</h1>
<h2 id="do">Do</h2>
<pre><code>// Do executes and returns the results of the given function, making
// sure that only one execution is in-flight for a given key at a
// time. If a duplicate comes in, the duplicate caller waits for the
// original to complete and receives the same results.
// The return value shared indicates whether v was given to multiple callers.
// Doæ‰§è¡Œå¹¶è¿”å›ç»™å®šå‡½æ•°çš„ç»“æœï¼Œç¡®ä¿åœ¨ç»™å®šæ—¶é—´ä»…å¯¹ç»™å®šé”®è¿›è¡Œä¸€æ¬¡æ‰§è¡Œã€‚
// å¦‚æœå‡ºç°é‡å¤ï¼Œåˆ™é‡å¤çš„è°ƒç”¨è€…å°†ç­‰å¾…åŸå§‹è¯·æ±‚æ¥æ”¶åˆ°ç›¸åŒçš„ç»“æœã€‚
// å…±äº«çš„è¿”å›å€¼æŒ‡ç¤ºæ˜¯å¦å°†våˆ†é…ç»™å¤šä¸ªè°ƒç”¨è€…ã€‚
func (g *Group) Do(key string, fn func() (interface{}, error)) (v interface{}, err error, shared bool) {
    // åŠ é”ï¼Œä¸»è¦é˜²æ­¢è¯·æ±‚é‡å¤è®°å½•ï¼Œå¹¶éåŠ é”å»åšè¯·æ±‚
	g.mu.Lock()
	if g.m == nil {
		g.m = make(map[string]*call)
	}
    // æ ¡éªŒæ˜¯å¦å·²ç»å®Œæˆè¯·æ±‚ï¼Œæœ‰åˆ™ç›´æ¥è¿”å›ï¼Œsharedè‚¯å®šä¸ºtrue
	if c, ok := g.m[key]; ok {
		c.dups++
		g.mu.Unlock()
		c.wg.Wait()
		return c.val, c.err, true
	}
    // æ ¡éªŒæ˜¯æ–°çš„è¯·æ±‚ï¼ŒwaitGroupåŠ 1ï¼Œå­˜å‚¨ï¼Œè§£é”
    // æ³¨æ„ï¼Œåªæœ‰çœŸæ­£å‘èµ·è¯·æ±‚æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡ŒwaitGroupåŠ 1
	c := new(call)
	c.wg.Add(1)
	g.m[key] = c
	g.mu.Unlock()
    // å®é™…å»è¯·æ±‚ï¼Œè¿”å›ç»“æœï¼Œæ­¤æ—¶
	g.doCall(c, key, fn)
    // æ­¤æ—¶dupsåº”è¯¥æ˜¯æ’å®šä¸º0çš„ï¼Ÿæ²¡æƒ³æ˜ç™½ä¸ºä»€ä¹ˆéœ€è¦åˆ¤æ–­ï¼Œæ‰‹åŠ¨æ‰§è¡Œè¿‡Forgetæ—¶ï¼Ÿ
	return c.val, c.err, c.dups &gt; 0
}
</code></pre>
<h2 id="dochan">DoChan</h2>
<pre><code>// DoChan is like Do but returns a channel that will receive the
// results when they are ready.
// æ•´ä½“ä¸Šä¸Doå‡½æ•°å¾ˆç±»ä¼¼ï¼Œåªæ˜¯è¿”å›ç»“æœå˜ä¸ºäº†chan
func (g *Group) DoChan(key string, fn func() (interface{}, error)) &lt;-chan Result {
	ch := make(chan Result, 1)
	g.mu.Lock()
	if g.m == nil {
		g.m = make(map[string]*call)
	}
	if c, ok := g.m[key]; ok {
		c.dups++
		c.chans = append(c.chans, ch)
		g.mu.Unlock()
		return ch
	}
	c := &amp;call{chans: []chan&lt;- Result{ch}}
	c.wg.Add(1)
	g.m[key] = c
	g.mu.Unlock()

	go g.doCall(c, key, fn)

	return ch
}
</code></pre>
<h2 id="docall">doCall</h2>
<pre><code>// doCall handles the single call for a key.
// å®é™…æ‰§è¡Œå‡½æ•°
func (g *Group) doCall(c *call, key string, fn func() (interface{}, error)) {
	c.val, c.err = fn()
	c.wg.Done()
    // è¯·æ±‚å®Œç»“æœï¼Œç½®å¥½waitGroupçŠ¶æ€ Doneï¼ŒåŠ é”å¼€å§‹å¤„ç†åç»­é€»è¾‘
	g.mu.Lock()
    // é»˜è®¤forgottenä¸ºfalseï¼Œä¼šå»åˆ é™¤è¯·æ±‚å¥½çš„çŠ¶æ€ï¼Œæ‰€ä»¥å•é£åªæ§åˆ¶äº†åŒä¸€æ—¶é—´ç›¸åŒè¯·æ±‚
	if !c.forgotten {
		delete(g.m, key)
	}
    // å°†chansä¸­çš„ç»“æœå‘å‡ºå»
	for _, ch := range c.chans {
		ch &lt;- Result{c.val, c.err, c.dups &gt; 0}
	}
	g.mu.Unlock()
}
</code></pre>
<h2 id="forget">Forget</h2>
<pre><code>// Forget tells the singleflight to forget about a key.  Future calls
// to Do for this key will call the function rather than waiting for
// an earlier call to complete.
func (g *Group) Forget(key string) {
	g.mu.Lock()
    // é˜²æ­¢é‡å¤åˆ é™¤
	if c, ok := g.m[key]; ok {
		c.forgotten = true
	}
    // åˆ é™¤åï¼ŒåŒæ ·çš„è¯·æ±‚ï¼Œä¼šåŒæ—¶å»çœŸå®çš„å‘èµ·è¯·æ±‚
	delete(g.m, key)
	g.mu.Unlock()
}
</code></pre>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>å¹¶å‘æ˜¯ä¸€ä¸ªåŒåˆƒå‰‘ï¼ŒèŠ‚çº¦äº†æ—¶é—´ï¼Œä½†æ˜¯ä¹Ÿå¸¦æ¥äº†å¾ˆå¤šçš„é—®é¢˜ï¼Œä¸æ–­å­¦ä¹ ï¼Œä¸æ–­è¿›æ­¥ï¼Œè‡ªå·±è¦å­¦ä¹ çš„è¿˜æœ‰å¾ˆå¤šï¼Œå…±å‹‰ï¼ğŸ’ªğŸ’ª<br>
å¸Œæœ›èƒ½ç”¨å¥½å¹¶å‘è¿™ä¸ªå·¥å…·ï¼Œè§£å†³æ›´å¤šçš„é—®é¢˜ã€‚</p>
<h1 id="å¼•ç”¨">å¼•ç”¨</h1>
<p><a href="https://blog.csdn.net/yang198907/article/details/108690876">æ·±å…¥ç†è§£singleflight</a><br>
<a href="https://www.codeleading.com/article/591682326/">æºç åˆ†æ-singleflight</a><br>
<a href="https://www.jianshu.com/p/ddaec84de653">singleflightæºç æ³¨é‡Š</a><br>
<a href="https://github.com/cch123/golang-notes/blob/master/sync.md">æ›¹å¤§golangç¬”è®° - syncåŒ…</a><br>
<a href="https://blog.csdn.net/weixin_43183475/article/details/105093355">singleflight é˜²ç¼“å­˜å‡»ç©¿ ä½¿ç”¨åŠåŸç†</a></p>

                                </div>
                    </article>
                    <!--  -->
                    
                        <div class="next-post">
                            <div class="next">ä¸‹ä¸€ç¯‡</div>
                            <a href="https://freephenix.github.io/yuan-ma-za-huo-pu-syncwaitgroup/">
                                <h3 class="post-title">
                                    æºç æ‚è´§é“ºï¼šsync.WaitGroup
                                </h3>
                            </a>
                        </div>
                        
                            <div id="disqus_thread"></div>
                            <div id="gitalk-container"></div>
                </div>
                <!-- middle -->
                <div class="main-container-middle"></div>
                <!-- right -->
                <div id="sidebar" class="main-container-right">
                    
                        <!-- toc -->
                        
    <div class="toc-card i-card ">
        <div class="toc-title i-card-title">ç›®å½•</div>
        <div class="toc-content">
            <ul class="markdownIt-TOC">
<li><a href="#%E7%AE%80%E4%BB%8B">ç®€ä»‹</a></li>
<li><a href="#%E7%BB%93%E6%9E%84%E4%BD%93">ç»“æ„ä½“</a></li>
<li><a href="#%E6%96%B9%E6%B3%95">æ–¹æ³•</a>
<ul>
<li><a href="#do">Do</a></li>
<li><a href="#dochan">DoChan</a></li>
<li><a href="#docall">doCall</a></li>
<li><a href="#forget">Forget</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
<li><a href="#%E5%BC%95%E7%94%A8">å¼•ç”¨</a></li>
</ul>

        </div>
        <script>
            function locateCatelogList() {
                /*è·å–æ–‡ç« ç›®å½•é›†åˆ,å¯é€šè¿‡:headerè¿‡æ»¤å™¨*/
                var alis = $('.post-content :header');
                /*è·å–ä¾§è¾¹æ ç›®å½•åˆ—è¡¨é›†åˆ**/
                var sidebar_alis = $('.markdownIt-TOC a');
                /*è·å–æ»šåŠ¨æ¡åˆ°é¡¶éƒ¨çš„è·ç¦»*/
                var scroll_height = $(window).scrollTop();
                for (var i = 0; i < alis.length; i++) {
                    /*è·å–é”šç‚¹é›†åˆä¸­çš„å…ƒç´ åˆ†åˆ«åˆ°é¡¶ç‚¹çš„è·ç¦»*/
                    var a_height = $(alis[i]).offset().top;
                    if (a_height < scroll_height) {
                        /*é«˜äº®æ˜¾ç¤º*/
                        sidebar_alis.removeClass('on');
                        $(sidebar_alis[i]).addClass('on');
                    }
                }
            }
            $(function() {
                /*ç»‘å®šæ»šåŠ¨äº‹ä»¶ */
                $(window).bind('scroll', locateCatelogList);
            });
        </script>
    </div>
    
                            

                </div>




            </div>


            <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | 
  <a class="rss" href="https://freephenix.github.io//atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>


    </div>
    <script>
        $('#sidebar').stickySidebar({
            topSpacing: 80,
            // bottomSpacing: 60
        });
    </script>
    
        
            <script>
    window.onload = function() {
        var gitalk = new Gitalk({
            clientID: '008503f8c8bca8787fbe',
            clientSecret: '5f789f71e3288ff1866d17523348881053068eb4',
            repo: 'freephenix.github.io',
            owner: 'freephenix',
            admin: ['freephenix'],
            id: (location.pathname).substring(0, 49), // Ensure uniqueness and length less than 50
            distractionFreeMode: false // Facebook-like distraction free mode
        })

        gitalk.render('gitalk-container')
    }
</script>
                

                    
                                
</body>

</html>